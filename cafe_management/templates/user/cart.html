{% extends "base.html" %}

{% block title %}장바구니 - 카페 주문 시스템{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-shopping-cart"></i> 장바구니
                        {% if cart %}
                        <span class="badge bg-primary ms-2">{{ cart|length }}개 상품</span>
                        {% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    {% if cart %}
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>메뉴</th>
                                    <th>온도</th>
                                    <th>가격</th>
                                    <th>수량</th>
                                    <th>소계</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cart_key, item in cart.items() %}
                                <tr>
                                    <td>
                                        <strong>{{ item.menu_name }}</strong>
                                        {% if item.special_request %}
                                        <br><small class="text-muted">{{ item.special_request }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.temperature == 'ice' %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-snowflake"></i> 아이스
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-fire"></i> 핫
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>{{ "{:,}".format(item.price|int) }}원</td>
                                    <td>
                                        <form method="post" action="{{ url_for('update_cart') }}" class="d-inline">
                                            <input type="hidden" name="cart_key" value="{{ cart_key }}">
                                            <div class="input-group" style="width: 120px;">
                                                <button class="btn btn-outline-secondary btn-sm" type="button" 
                                                        onclick="updateQuantity('{{ cart_key }}', -1)">-</button>
                                                <input type="number" class="form-control form-control-sm text-center" 
                                                       name="quantity" value="{{ item.quantity }}" min="1" max="10"
                                                       onchange="this.form.submit()">
                                                <button class="btn btn-outline-secondary btn-sm" type="button" 
                                                        onclick="updateQuantity('{{ cart_key }}', 1)">+</button>
                                            </div>
                                        </form>
                                    </td>
                                    <td><strong>{{ "{:,}".format(item.subtotal|int) }}원</strong></td>
                                    <td>
                                        <form method="post" action="{{ url_for('update_cart') }}" class="d-inline">
                                            <input type="hidden" name="cart_key" value="{{ cart_key }}">
                                            <input type="hidden" name="quantity" value="0">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" 
                                                    onclick="return confirm('이 상품을 삭제하시겠습니까?')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <th colspan="4">총 금액</th>
                                    <th>{{ "{:,}".format(total_amount|int) }}원</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <div>
                            <a href="{{ url_for('user_menu') }}" class="btn btn-outline-primary">
                                <i class="fas fa-plus"></i> 메뉴 더 보기
                            </a>
                            <form method="post" action="{{ url_for('clear_cart') }}" class="d-inline">
                                <button type="submit" class="btn btn-outline-warning" 
                                        onclick="return confirm('장바구니를 비우시겠습니까?')">
                                    <i class="fas fa-broom"></i> 장바구니 비우기
                                </button>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">장바구니가 비어있습니다</h4>
                        <p class="text-muted">메뉴를 확인하고 원하는 상품을 담아보세요.</p>
                        <a href="{{ url_for('user_menu') }}" class="btn btn-primary">
                            <i class="fas fa-utensils"></i> 메뉴 보기
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        {% if cart %}
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-receipt"></i> 주문 정보
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('place_order') }}" id="orderForm">
                        <div class="mb-3">
                            <label for="customer_name" class="form-label">
                                <i class="fas fa-user"></i> 고객명 <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="customer_name" name="customer_name" 
                                   required placeholder="주문자 이름을 입력하세요">
                        </div>
                        
                        <div class="mb-3">
                            <label for="delivery_location" class="form-label">
                                <i class="fas fa-map-marker-alt"></i> 배달 장소 <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="delivery_location" name="delivery_location" 
                                   required placeholder="예: 201호, 3층 회의실">
                        </div>
                        
                        <div class="mb-3">
                            <label for="delivery_time" class="form-label">
                                <i class="fas fa-clock"></i> 희망 배달 시간
                            </label>
                            <select class="form-select" id="delivery_time" name="delivery_time">
                                <option value="">선택하세요</option>
                                <option value="즉시">즉시</option>
                                <option value="10분 후">10분 후</option>
                                <option value="20분 후">20분 후</option>
                                <option value="30분 후">30분 후</option>
                                <option value="점심시간(12:00-13:00)">점심시간(12:00-13:00)</option>
                                <option value="오후 휴식시간(15:00-16:00)">오후 휴식시간(15:00-16:00)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="order_request" class="form-label">
                                <i class="fas fa-comment"></i> 주문 요청사항
                            </label>
                            <textarea class="form-control" id="order_request" name="order_request" rows="3"
                                    placeholder="예: 문 앞에 놓아주세요, 벨 누르지 마세요 등"></textarea>
                        </div>
                        
                        <hr>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>상품 금액:</span>
                                <span>{{ "{:,}".format(total_amount|int) }}원</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>배달비:</span>
                                <span class="text-success">무료</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <strong>총 결제금액:</strong>
                                <strong class="text-primary">{{ "{:,}".format(total_amount|int) }}원</strong>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-credit-card"></i> 주문하기
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                주문 완료 후 취소/변경이 어렵습니다. 신중히 확인해주세요.
                            </small>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Order Summary -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-list-alt"></i> 주문 요약
                    </h6>
                </div>
                <div class="card-body">
                    {% for cart_key, item in cart.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <small class="fw-bold">{{ item.menu_name }}</small>
                            <br>
                            <small class="text-muted">
                                {{ item.temperature|upper }} × {{ item.quantity }}
                                {% if item.special_request %}
                                - {{ item.special_request[:20] }}...
                                {% endif %}
                            </small>
                        </div>
                        <small class="fw-bold">{{ "{:,}".format(item.subtotal|int) }}원</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .table td, .table th {
        vertical-align: middle;
    }
    
    .input-group {
        max-width: 120px;
    }
    
    .card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .btn-lg {
        padding: 12px 20px;
        font-size: 1.1rem;
    }
    
    .text-primary {
        font-size: 1.2rem;
    }
    
    @media (max-width: 768px) {
        .table-responsive {
            font-size: 0.9rem;
        }
        
        .input-group {
            max-width: 100px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
function updateQuantity(cartKey, change) {
    const form = document.querySelector(`form input[value="${cartKey}"]`).closest('form');
    const quantityInput = form.querySelector('input[name="quantity"]');
    let currentQuantity = parseInt(quantityInput.value);
    let newQuantity = currentQuantity + change;
    
    if (newQuantity >= 1 && newQuantity <= 10) {
        quantityInput.value = newQuantity;
        form.submit();
    }
}

// 주문 폼 검증
document.getElementById('orderForm').addEventListener('submit', function(e) {
    const customerName = document.getElementById('customer_name').value.trim();
    const deliveryLocation = document.getElementById('delivery_location').value.trim();
    
    if (!customerName) {
        e.preventDefault();
        alert('고객명을 입력해주세요.');
        document.getElementById('customer_name').focus();
        return false;
    }
    
    if (!deliveryLocation) {
        e.preventDefault();
        alert('배달 장소를 입력해주세요.');
        document.getElementById('delivery_location').focus();
        return false;
    }
    
    // 확인 메시지
    if (!confirm('주문을 진행하시겠습니까?')) {
        e.preventDefault();
        return false;
    }
});

// 숫자 입력 검증
document.querySelectorAll('input[type="number"]').forEach(function(input) {
    input.addEventListener('input', function() {
        let value = parseInt(this.value);
        if (value < 1) this.value = 1;
        if (value > 10) this.value = 10;
    });
});
</script>
{% endblock %} 