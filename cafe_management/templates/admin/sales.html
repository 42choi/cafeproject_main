{% extends "base.html" %}

{% block title %}매출 관리 - 카페 주문 시스템{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2>
                <i class="fas fa-chart-bar"></i> 매출 관리
            </h2>
        </div>
    </div>
    
    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter"></i> 기간 필터
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('filter_sales') }}" class="row g-3">
                        <div class="col-md-4">
                            <label for="start_date" class="form-label">시작일</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" 
                                   value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="end_date" class="form-label">종료일</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" 
                                   value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> 조회
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="btn-toolbar" role="toolbar">
                                <div class="btn-group me-2" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('today')">오늘</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('week')">이번 주</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('month')">이번 달</button>
                                </div>
                                <div class="btn-group" role="group">
                                    <form method="post" action="{{ url_for('export_period_orders') }}" class="d-inline">
                                        <input type="hidden" name="start_date" value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}">
                                        <input type="hidden" name="end_date" value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}">
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="fas fa-download"></i> Excel 다운로드
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sales Summary -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                총 매출
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ "{:,}".format(sales_data.total_sales) }}원
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-won-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                총 주문 수
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ sales_data.total_orders }}건
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                평균 주문 금액
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {% if sales_data.total_orders > 0 %}
                                {{ "{:,}".format((sales_data.total_sales / sales_data.total_orders)|int) }}원
                                {% else %}
                                0원
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calculator fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                일평균 매출
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {% if start_date and end_date %}
                                {% set days = (end_date - start_date).days + 1 %}
                                {{ "{:,}".format((sales_data.total_sales / days)|int) }}원
                                {% else %}
                                {{ "{:,}".format(sales_data.total_sales) }}원
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-day fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Orders Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> 주문 내역
                        {% if start_date and end_date %}
                        ({{ start_date.strftime('%Y-%m-%d') }} ~ {{ end_date.strftime('%Y-%m-%d') }})
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if sales_data.orders %}
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="ordersTable">
                            <thead class="table-light">
                                <tr>
                                    <th>주문번호</th>
                                    <th>주문일시</th>
                                    <th>고객명</th>
                                    <th>배달장소</th>
                                    <th>주문금액</th>
                                    <th>상태</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in sales_data.orders %}
                                <tr>
                                    <td>{{ order.id }}</td>
                                    <td>{{ order.order_date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>{{ order.customer_name }}</td>
                                    <td>{{ order.delivery_location }}</td>
                                    <td class="text-end">{{ "{:,}".format(order.total_amount) }}원</td>
                                    <td>
                                        {% if order.status == 'pending' %}
                                        <span class="badge bg-warning">대기중</span>
                                        {% elif order.status == 'preparing' %}
                                        <span class="badge bg-info">준비중</span>
                                        {% elif order.status == 'ready' %}
                                        <span class="badge bg-primary">준비완료</span>
                                        {% elif order.status == 'completed' %}
                                        <span class="badge bg-success">완료</span>
                                        {% elif order.status == 'cancelled' %}
                                        <span class="badge bg-danger">취소</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-info" onclick="viewOrderDetail({{ order.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="{{ url_for('print_receipt', order_id=order.id) }}" 
                                               class="btn btn-outline-primary" target="_blank">
                                                <i class="fas fa-print"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">해당 기간에 주문이 없습니다</h4>
                        <p class="text-muted">다른 기간을 선택하여 조회해보세요.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Detail Modal -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">주문 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- 주문 상세 정보가 여기에 로드됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .border-left-primary {
        border-left: 0.25rem solid #4e73df !important;
    }
    
    .border-left-success {
        border-left: 0.25rem solid #1cc88a !important;
    }
    
    .border-left-info {
        border-left: 0.25rem solid #36b9cc !important;
    }
    
    .border-left-warning {
        border-left: 0.25rem solid #f6c23e !important;
    }
    
    .text-xs {
        font-size: 0.7rem;
    }
    
    .text-gray-300 {
        color: #dddfeb !important;
    }
    
    .text-gray-800 {
        color: #5a5c69 !important;
    }
    
    .table th {
        border-top: none;
        font-weight: 600;
        font-size: 0.9rem;
        color: #5a5c69;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0,0,0,.075);
    }
    
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
    }
    
    .card {
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// 날짜 범위 설정
function setDateRange(range) {
    const today = new Date();
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    switch(range) {
        case 'today':
            const todayStr = today.toISOString().split('T')[0];
            startDateInput.value = todayStr;
            endDateInput.value = todayStr;
            break;
        case 'week':
            const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
            const weekEnd = new Date(today.setDate(today.getDate() - today.getDay() + 6));
            startDateInput.value = weekStart.toISOString().split('T')[0];
            endDateInput.value = weekEnd.toISOString().split('T')[0];
            break;
        case 'month':
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            startDateInput.value = monthStart.toISOString().split('T')[0];
            endDateInput.value = monthEnd.toISOString().split('T')[0];
            break;
    }
}

// 주문 상세 정보 보기
async function viewOrderDetail(orderId) {
    try {
        // 여기서는 간단히 테이블의 정보를 모달에 표시
        const row = document.querySelector(`tr td:first-child`);
        if (row && row.textContent == orderId) {
            const rowData = row.parentElement.children;
            const detailContent = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>기본 정보</h6>
                        <table class="table table-sm">
                            <tr><th>주문번호:</th><td>${rowData[0].textContent}</td></tr>
                            <tr><th>주문일시:</th><td>${rowData[1].textContent}</td></tr>
                            <tr><th>고객명:</th><td>${rowData[2].textContent}</td></tr>
                            <tr><th>배달장소:</th><td>${rowData[3].textContent}</td></tr>
                            <tr><th>주문금액:</th><td>${rowData[4].textContent}</td></tr>
                            <tr><th>상태:</th><td>${rowData[5].innerHTML}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>주문 항목</h6>
                        <p class="text-muted">상세 항목은 영수증을 확인해주세요.</p>
                        <a href="/admin/print_receipt/${orderId}" class="btn btn-primary btn-sm" target="_blank">
                            <i class="fas fa-print"></i> 영수증 보기
                        </a>
                    </div>
                </div>
            `;
            document.getElementById('orderDetailContent').innerHTML = detailContent;
            new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
        }
    } catch (error) {
        alert('주문 정보를 불러오는 중 오류가 발생했습니다.');
    }
}

// DataTable 초기화 (페이지네이션과 검색 기능 추가)
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('ordersTable');
    if (table && table.rows.length > 1) {
        // 간단한 테이블 기능들을 추가할 수 있습니다.
        console.log('주문 테이블이 로드되었습니다.');
    }
});
</script>
{% endblock %} 